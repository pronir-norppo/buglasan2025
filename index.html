<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Buglasan Deployment Dashboard — Fixed View</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    :root{
      --bg:#0a0a0a; --panel:#121212; --text:#f3f3f3; --gold:#ffcc00;
      --accent1:#ff0077; --accent2:#ff6600; --accent3:#ffee00; --accent4:#00ff99; --accent5:#0099ff;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,Arial,sans-serif;}
    header{
      background:linear-gradient(90deg,var(--accent1),var(--accent2),var(--accent3),var(--accent4),var(--accent5));
      background-size:300% 300%; animation:gradientFlow 8s linear infinite;
      padding:10px 16px; display:flex; align-items:center; gap:14px;
    }
    @keyframes gradientFlow{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
    header img{height:46px;border-radius:50%;background:#fff;padding:4px}
    header h1{margin:0;font-size:18px;font-weight:700;color:#fff;text-shadow:0 1px 6px rgba(0,0,0,0.6)}
    nav{margin-left:auto;display:flex;gap:10px;align-items:center}
    nav select,nav button{transition:0.2s all}
    nav select:hover,nav button:hover{background:#0f0;color:#000}
    nav select,nav button{padding:6px 10px;border-radius:8px;border:none;background:#1f1f1f;color:#fff}
    .app{display:flex;height:calc(100vh - 72px)}
    .sidebar{width:32%;min-width:320px;background:var(--panel);padding:14px;overflow:auto;border-right:1px solid rgba(255,255,255,0.04)}
	h1{margin-left:10px; padding: 4px 8px; background: rgba(0,0,0,0.4); border-radius: 4px; color: #fff; font-family: 'Helvetica'; font-size: 28px; font-weight: 400; letter-spacing: 0.5px;}
    h2{margin:0 0 8px 0;color:var(--gold);font-size:14px;text-transform:uppercase}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.04);vertical-align:middle}
    th{color:var(--gold);text-align:left}
    .person-row{cursor:pointer}
    .person-row:hover{background:rgba(0,255,204,0.03)}
    .person-row.selected{background:rgba(255,204,0,0.08);color:var(--gold)}
    .main{flex:1;position:relative;padding:8px}
    #map{height:100%;border-radius:8px;overflow:hidden}
    #summaryBox{position:absolute;left:12px;bottom:12px;background:rgba(0,0,0,0.6);padding:8px;border-radius:6px;color:var(--gold);font-size:10px;}
    .leaflet-popup-content-wrapper { max-height: 70vh; overflow-y: auto; }
    .leaflet-popup-content { font-size: 12px; line-height: 1.4; max-width: 300px; }
    .leaflet-popup-content img { max-width: 100%; height: auto; }
    .fa-marker { 
      font-size: 20px; 
      color: white; 
      background: var(--marker-bg, yellow); 
      padding: 5px; 
      border-radius: 50%; 
      width: 30px; 
      height: 30px; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.3); 
    }
    @media (max-width:880px){ .sidebar{width:42%} }
  </style>
</head>
<body>
  <header>
    <img src="https://scontent.fmnl9-1.fna.fbcdn.net/v/t39.30808-6/514281754_1126539702844420_1256391277100551497_n.jpg?_nc_cat=110&ccb=1-7&_nc_sid=6ee11a&_nc_eui2=AeH5aJFIMxbymRyyOExUBlMBTjlVyG1LorJOOVXIbUuisvaD7z8ceLHbLi_Ixvyl2nU&_nc_ohc=fEQKNyQKcFMQ7kNvwF-n6lE&_nc_oc=AdkmYO2-kyK1QQbBcUWpgTx7qE3g9wxAOkqB6B6BQPSvbL9Eq7Mb_97zjBnfrRPaq5M&_nc_zt=23&_nc_ht=scontent.fmnl9-1.fna&_nc_gid=cJ34vJkMCPV5Ltpsa_kwAQ&oh=00_AffMTi0LRy90qdiymzLIv2ia3H5adhPzVGEzbKCWkFXN6Q&oe=68EA51B9" alt="Buglasan Logo">
    <h1>Buglasan Festival 2025 — Deployment Dashboard</h1>
    <nav>
      <select id="areaFilter"><option value="All">All Areas</option></select>
      <select id="shiftFilterTop"><option value="All">All Shifts</option></select>
      <button id="refreshBtn">Refresh</button>
    </nav>
    <div id="clock" style="margin-left:10px; padding: 4px 8px; background: rgba(0,0,0,0.4); border-radius: 4px; color: #fff; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 12px; font-weight: 400; letter-spacing: 0.5px;"></div>
  </header>

  <div class="app">
    <div class="sidebar">
      <div id="lastUpdated" style="font-size:11px;color:#aaa;margin-bottom:4px">Last updated: --</div><br>
      <h2>Personnel</h2>
      <table id="personnelTable">
        <thead>
          <tr><th>Name</th><th>Contact</th><th>Call Sign</th><th>Shift</th></tr>
        </thead>
        <tbody></tbody>
      </table>
      <div style="margin-top:10px"><span id="togglePersonnel" style="color:var(--accent5);cursor:pointer;display:none">Show more</span></div>
    </div>

    <div class="main">
      <div id="map"></div>
      <div id="summaryBox">Summary...</div>
    </div>
  </div>

<script>
/* -------------------- Configuration -------------------- */
const DEPLOYMENT_CSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1vR4VtzZRxV-Z2wes5L5yta77awXf7PMEaDJPu1nvFr1hXEcRa7NaHPk2R0McPW-xMTsKSCuufRXoE7U/pub?output=csv";

/* -------------------- Helpers -------------------- */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }
function normalize(s){ return (s||'').toString().trim().toLowerCase(); }

/* tolerant field getter: try exact, then case-insensitive contains */
function getField(row, ...keys){
  if(!row) return '';
  for(const k of keys){ if(k in row && row[k]) return row[k]; }
  const cols = Object.keys(row||{});
  for(const k of keys){
    const target = k.toString().trim().toLowerCase();
    for(const c of cols){
      if(c && c.toString().trim().toLowerCase().includes(target) && row[c]) return row[c];
    }
  }
  return '';
}

/* fetch CSV safely (adds &t= only when needed) */
async function fetchCsv(url){
  const sep = url.includes('?') ? '&' : '?';
  const res = await fetch(url + `${sep}t=${Date.now()}`, { cache: 'no-store' });
  if(!res.ok) throw new Error('CSV fetch failed: ' + res.status);
  const txt = await res.text();
  return Papa.parse(txt, { header: true, skipEmptyLines: true }).data;
}

/* parse latitude,longitude strings */
function parseLatLng(val){
  if(!val) return null;
  const parts = String(val).replace(/[()]/g,'').split(/[;,\s]+/).filter(Boolean);
  if(parts.length>=2){
    const a = parseFloat(parts[0]), b = parseFloat(parts[1]);
    if(!isNaN(a) && !isNaN(b)) return { lat: a, lng: b };
  }
  return null;
}

/* parse personnel strings like "PSSg Ray (09553279424)" or "Name - 0955..." or "+639..." */
function parsePersonnel(raw){
  if(!raw) return [];
  return String(raw).split(/[;\n]+/).map(x=>x.trim()).filter(Boolean).map(p=>{
    const m = p.match(/^(.*?)[\s\(,-]*(\+?[0-9]{8,14})\)?$/);
    if(m){
      let num = m[2].trim();
      const digits = num.replace(/\D/g,'');
      if(digits.length===11 && digits.startsWith('0')) num = '+63' + digits.slice(1);
      else if(digits.length===10 && digits.startsWith('9')) num = '+63' + digits;
      else if(!num.startsWith('+') && /^\d+$/.test(num)) num = digits;
      return { name: m[1].trim(), mobile: num };
    }
    return { name: p, mobile: '' };
  });
}

/* convert google drive/photo links to displayable image URL when possible */
function makeDisplayUrl(raw){
  if(!raw) return '';
  let url = String(raw).trim();
  const m = url.match(/IMAGE\(["']?(https[^"')]+)["']?\)/i);
  if(m) url = m[1];
  try {
    if(url.includes("open?id=")){
      const id = new URL(url).searchParams.get("id");
      if(id) return `https://drive.google.com/thumbnail?id=${id}&sz=w420`;
    }
    if(url.includes("/file/d/")){
      const match = url.match(/\/file\/d\/([^/]+)\//);
      if(match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w420`;
    }
    if(url.startsWith("http")) return url;
  } catch(e){
    console.warn("[IMG PARSER] Failed:", raw, e);
  }
  return 'https://via.placeholder.com/160x90.png';
}

/* normalize phone for viber */
function normalizeToViber(num){
  if(!num) return '';
  let n = String(num).trim();
  if(n.startsWith('+')) return n;
  const digits = n.replace(/\D/g,'');
  if(digits.length===11 && digits.startsWith('0')) return '+63'+digits.slice(1);
  if(digits.length===10 && digits.startsWith('9')) return '+63'+digits;
  return digits || '';
}

/* -------------------- DOM refs -------------------- */
const areaFilter = document.getElementById('areaFilter');
const shiftFilterTop = document.getElementById('shiftFilterTop');
const personnelTbody = document.querySelector('#personnelTable tbody');
const summaryBox = document.getElementById('summaryBox');
const togglePersonnel = document.getElementById('togglePersonnel');

/* -------------------- State -------------------- */
let allData = [], displayedMarkers = [], personnelExpanded = false, selectedStation = 'All', selectedShift = 'All';

// ---- Map Setup ----
const DEFAULT_CENTER = [9.3095427, 123.2887356];
const DEFAULT_ZOOM = 14.5;

const map = L.map('map', {
  zoomSnap: 0.1,
  zoomDelta: 0.5,
  minZoom: 4,
  maxZoom: 22,
  zoomControl: true
}).setView(DEFAULT_CENTER, DEFAULT_ZOOM);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; PICTMU, NOrPPO, PRO NIR',
  maxZoom: 22
}).addTo(map);

map.whenReady(() => setTimeout(() => map.invalidateSize(), 200));

/* -------------------- Clock Function -------------------- */
function updateClock() {
  const now = new Date();
  const options = {
    timeZone: 'Asia/Manila',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour24: false
  };
  const timeString = now.toLocaleTimeString('en-US', options);
  document.getElementById('clock').textContent = timeString;
}

setInterval(updateClock, 1000);
updateClock();

/* -------------------- Markers & UI rendering -------------------- */
function clearMarkers(){
  displayedMarkers.forEach(m => { try { map.removeLayer(m.marker); } catch(e){} });
  displayedMarkers = [];
}

function renderPopup(record){
  const wrapper = document.createElement('div');
  wrapper.style.maxWidth = '300px';
  wrapper.style.maxHeight = '70vh';
  wrapper.style.overflowY = 'auto';
  let html = `<strong>${escapeHtml(record.area)}</strong><br>
    <b>Shift:</b> ${escapeHtml(record.shift)}<br>
    <b>Comms:</b> ${escapeHtml(record.comm)}<br>
    <b>Call Sign:</b> ${escapeHtml(record.callsign)}<br>
    <b>Standby:</b> ${escapeHtml(record.landmark)}<hr>`;
  if(record.PersonnelList && record.PersonnelList.length){
    record.PersonnelList.forEach(p => {
      const v = p.mobile || '';
      const viber = normalizeToViber(v);
      const link = viber ? `<a href="viber://chat?number=${encodeURIComponent(viber)}" style="color:#00ffcc;text-decoration:none">${escapeHtml(v)}</a>` : 'no mobile';
      html += `<div style="margin-bottom:6px"><b>${escapeHtml(p.name)}</b><br><span style="opacity:0.9">${link}</span></div>`;
    });
  }
  wrapper.innerHTML = html;

  if(record.photo){
    const imgUrl = makeDisplayUrl(record.photo || "");
    if(imgUrl){
      const img = document.createElement('img');
      img.src = imgUrl;
      img.style.maxWidth = '100%';
      img.style.height = 'auto';
      img.style.display = 'block';
      img.style.marginTop = '6px';
      img.style.borderRadius = '8px';
      img.style.boxShadow = '0 0 12px rgba(0,255,204,0.3)';
      img.onerror = () => { img.style.display = 'none'; };
      wrapper.appendChild(img);
    }
  }
  return wrapper;
}

function addMarkerFor(record){
  if(!record.latlng) return null;
  const s = normalize(record.shift || '');
  let color = 'yellow';
  if(s.includes('alpha')) color = 'green';
  else if(s.includes('bravo')) color = 'blue';
  else if(s.includes('charlie')) color = 'orange';
  
  // Create a Font Awesome icon with background color
  const icon = L.divIcon({
    html: `<i class="fas fa-map-marker-alt fa-marker" style="--marker-bg: ${color};"></i>`,
    className: '',
    iconSize: [30, 30],
    iconAnchor: [15, 30],
    popupAnchor: [0, -30]
  });
  
  const marker = L.marker([record.latlng.lat, record.latlng.lng], { icon }).addTo(map);
  marker.bindPopup(renderPopup(record));
  displayedMarkers.push({ marker, data: record });
  return marker;
}

/* -------------------- Table rendering -------------------- */
function renderPersonnelTable(filtered){
  personnelTbody.innerHTML = '';
  if(selectedStation === 'All'){
    personnelTbody.innerHTML = '<tr><td colspan="4" style="opacity:0.6;padding:10px;text-align:center">Select Area to view duty personnel</td></tr>';
    togglePersonnel.style.display = 'none';
    return;
  }
  const rows = [];
  filtered.forEach(r => {
    const names = (r.PersonnelList || []).map(p => p.name).join(', ');
    const mobile = (r.PersonnelList || []).find(p => p.mobile) || {};
    rows.push({ name: names || 'Unnamed', mobile: mobile.mobile || '', call: r.callsign || '', shift: r.shift || '', r });
  });

  const visible = personnelExpanded ? rows : rows.slice(0,6);
  visible.forEach(p => {
    const tr = document.createElement('tr');
    tr.className = 'person-row';
    const viberNum = normalizeToViber(p.mobile);
    const viberLink = viberNum ? `<a href="viber://chat?number=${encodeURIComponent(viberNum)}" style="color:#00ffcc;text-decoration:none">${escapeHtml(p.mobile)}</a>` : 'no mobile';
    tr.innerHTML = `<td>${escapeHtml(p.name)}</td><td>${viberLink}</td><td>${escapeHtml(p.call)}</td><td>${escapeHtml(p.shift)}</td>`;
    tr.onclick = () => {
      document.querySelectorAll('.person-row.selected').forEach(x => x.classList.remove('selected'));
      tr.className = 'person-row selected';
      const m = displayedMarkers.find(x => x.data === p.r);
      if(m){
        map.flyTo(m.marker.getLatLng(), 18);
        m.marker.openPopup();
      }
    };
    personnelTbody.appendChild(tr);
  });
  togglePersonnel.style.display = rows.length > 6 ? 'inline-block' : 'none';
  togglePersonnel.textContent = personnelExpanded ? 'Show less' : `Show more (${rows.length})`;
}

/* -------------------- Summary -------------------- */
function updateSummary(filtered){
  const total = filtered.reduce((a,r) => a + ((r.PersonnelList && r.PersonnelList.length) || 1), 0);
  summaryBox.innerHTML = (selectedStation === 'All') ? `Total Personnel: ${total}` : `<b>${escapeHtml(selectedStation)}</b><br>Personnel: ${total}`;
}

/* -------------------- Apply filters -------------------- */
function applyFilters(){
  clearMarkers();
  const filtered = allData.filter(d =>
    (selectedStation === 'All' || normalize(d.area) === normalize(selectedStation)) &&
    (selectedShift === 'All' || normalize(d.shift) === normalize(selectedShift))
  );

  if(!filtered.length){
    personnelTbody.innerHTML = '<tr><td colspan="4" style="opacity:0.6;padding:10px;text-align:center">No deployments found</td></tr>';
    summaryBox.innerHTML = '⚠️ No data found.';
    return;
  }

  filtered.forEach(r => addMarkerFor(r));
  renderPersonnelTable(filtered);
  updateSummary(filtered);
}

/* -------------------- Load CSV and initialize -------------------- */
async function loadData(){
  try{
    const rows = await fetchCsv(DEPLOYMENT_CSV);
    allData = rows.map(r => {
      const record = {
        raw: r,
        area: getField(r, 'Area of Deployment', 'Area'),
        shift: getField(r, 'Duty Shift', 'Shift'),
        comm: getField(r, 'Communication Capability', 'Comm'),
        callsign: getField(r, 'Call Sign', 'Callsign'),
        landmark: getField(r, 'Stanbypoint (Landmark)', 'Standbypoint', 'Standby Point'),
        photo: getField(r, 'Picture (with Timestamp)', 'Picture', 'Photo'),
        latlng: parseLatLng(getField(r, 'Lat_Long (e.g. 9.33608, 123.30659)', 'Lat_Long', 'Coordinates')),
        PersonnelList: parsePersonnel(getField(r, 'Personnel (Rank_FName_MI_LN (Contact #)', 'Personnel'))
      };
      if(record.photo) record.photo = makeDisplayUrl(record.photo);
      return record;
    });

    const areas = [...new Set(allData.map(d => (d.area || 'Unknown').trim()))].sort();
    areaFilter.innerHTML = '<option value="All">All Areas</option>' + areas.map(a => `<option value="${escapeHtml(a)}">${escapeHtml(a)}</option>`).join('');
    const shifts = [...new Set(allData.map(d => (d.shift || 'Unspecified').trim()))].sort();
    shiftFilterTop.innerHTML = '<option value="All">All Shifts</option>' + shifts.map(s => `<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join('');

    selectedStation = 'All'; selectedShift = 'All';
    applyFilters();
    updateTimestamp();
  }catch(err){
    console.error(err);
    alert('Failed to load CSV. Make sure the sheet is published as CSV and URL is public.');
  }
}

function updateTimestamp(){
  const el = document.getElementById('lastUpdated');
  if(!el) return;
  const now = new Date();
  const options = {year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'};
  el.textContent = "Last updated: " + now.toLocaleString('en-US', options);
}

/* -------------------- Events -------------------- */
areaFilter.onchange = () => { selectedStation = areaFilter.value; applyFilters(); updateTimestamp(); };
shiftFilterTop.onchange = () => { selectedShift = shiftFilterTop.value; applyFilters(); updateTimestamp(); };
togglePersonnel.onclick = () => { personnelExpanded = !personnelExpanded; applyFilters(); updateTimestamp(); };
document.getElementById('refreshBtn').onclick = () => loadData();

/* -------------------- Start -------------------- */
loadData();

</script>
</body>
</html>
